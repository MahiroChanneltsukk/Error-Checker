name: Web Console Error Checker

on:
  workflow_dispatch:
    inputs:
      urls:
        description: 'Ë¶ÅÊ£ÄÊü•ÁöÑURLÂàóË°®ÔºàÁî®ÈÄóÂè∑ÂàÜÈöîÔºâ'
        required: false
        default: ''
      duration:
        description: 'ÊØè‰∏™È°µÈù¢Á≠âÂæÖÊó∂Èó¥ÔºàÁßíÔºâ'
        required: false
        default: '30'
  schedule:
    - cron: '0 */6 * * *'  # ÊØè6Â∞èÊó∂ËøêË°å‰∏ÄÊ¨°

jobs:
  check-console-errors:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: |
          npm install puppeteer

      - name: Create error checker script
        run: |
          cat > check-errors.js << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');

          // ‰ªéÁéØÂ¢ÉÂèòÈáèÊàñÈÖçÁΩÆÊñá‰ª∂ËØªÂèñURLÂàóË°®
          function getUrlsToCheck() {
            const inputUrls = process.env.INPUT_URLS;
            const configPath = path.join(process.cwd(), 'urls-config.json');
            
            if (inputUrls && inputUrls.trim()) {
              return inputUrls.split(',').map(url => url.trim()).filter(Boolean);
            }
            
            if (fs.existsSync(configPath)) {
              const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
              return config.urls || [];
            }
            
            return [];
          }

          async function checkPageErrors(url, duration) {
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            const page = await browser.newPage();
            const errors = [];
            const warnings = [];
            const logs = [];
            const networkErrors = [];
            const resourceErrors = {
              css: [],
              js: [],
              images: [],
              fonts: [],
              ads: []
            };

            // ÁõëÂê¨ÊéßÂà∂Âè∞Ê∂àÊÅØ
            page.on('console', msg => {
              const type = msg.type();
              const text = msg.text();
              const location = msg.location();
              
              const logEntry = {
                type: type,
                message: text,
                url: location.url,
                line: location.lineNumber,
                column: location.columnNumber,
                timestamp: new Date().toISOString()
              };

              if (type === 'error') {
                errors.push(logEntry);
              } else if (type === 'warning') {
                warnings.push(logEntry);
              } else {
                logs.push(logEntry);
              }
            });

            // ÁõëÂê¨È°µÈù¢ÈîôËØØ
            page.on('pageerror', error => {
              errors.push({
                type: 'pageerror',
                message: error.message,
                stack: error.stack,
                timestamp: new Date().toISOString()
              });
            });

            // ÁõëÂê¨ÊâÄÊúâËØ∑Ê±ÇÂìçÂ∫î
            page.on('response', async response => {
              const url = response.url();
              const status = response.status();
              const resourceType = response.request().resourceType();

              // Ê£ÄÊµãÂ§±Ë¥•ÁöÑËµÑÊ∫êÂä†ËΩΩÔºà4xx, 5xxÈîôËØØÔºâ
              if (status >= 400) {
                const errorInfo = {
                  url: url,
                  status: status,
                  statusText: response.statusText(),
                  resourceType: resourceType,
                  timestamp: new Date().toISOString()
                };

                // ÂàÜÁ±ªËµÑÊ∫êÈîôËØØ
                if (url.match(/\.css$/i) || resourceType === 'stylesheet') {
                  resourceErrors.css.push(errorInfo);
                  errors.push({
                    type: 'css-load-error',
                    message: `Ê†∑ÂºèÊñá‰ª∂Âä†ËΩΩÂ§±Ë¥•: ${url} (${status})`,
                    url: url,
                    status: status,
                    timestamp: errorInfo.timestamp
                  });
                } else if (url.match(/\.js$/i) || resourceType === 'script') {
                  resourceErrors.js.push(errorInfo);
                  errors.push({
                    type: 'js-load-error',
                    message: `JavaScriptÊñá‰ª∂Âä†ËΩΩÂ§±Ë¥•: ${url} (${status})`,
                    url: url,
                    status: status,
                    timestamp: errorInfo.timestamp
                  });
                } else if (resourceType === 'image') {
                  resourceErrors.images.push(errorInfo);
                } else if (url.match(/\.(woff|woff2|ttf|eot|otf)$/i) || resourceType === 'font') {
                  resourceErrors.fonts.push(errorInfo);
                }

                // Ê£ÄÊµãÂπøÂëäÁõ∏ÂÖ≥ÈîôËØØ
                if (url.includes('googlesyndication') || 
                    url.includes('doubleclick') || 
                    url.includes('adservice') ||
                    url.includes('googleadservices') ||
                    url.includes('pagead') ||
                    url.includes('/ads/')) {
                  resourceErrors.ads.push(errorInfo);
                  errors.push({
                    type: 'ad-load-error',
                    message: `ÂπøÂëäÂä†ËΩΩÂ§±Ë¥•: ${url} (${status})`,
                    url: url,
                    status: status,
                    timestamp: errorInfo.timestamp
                  });
                }
              }
            });

            // ÁõëÂê¨ËØ∑Ê±ÇÂ§±Ë¥•ÔºàÁΩëÁªúÂ±ÇÈù¢ÁöÑÂ§±Ë¥•Ôºâ
            page.on('requestfailed', request => {
              const url = request.url();
              const resourceType = request.resourceType();
              const errorText = request.failure().errorText;

              const errorInfo = {
                url: url,
                method: request.method(),
                errorText: errorText,
                resourceType: resourceType,
                timestamp: new Date().toISOString()
              };

              networkErrors.push(errorInfo);

              // ÂàÜÁ±ªÁΩëÁªúÂ§±Ë¥•ÁöÑËµÑÊ∫ê
              if (url.match(/\.css$/i) || resourceType === 'stylesheet') {
                resourceErrors.css.push(errorInfo);
                errors.push({
                  type: 'css-network-error',
                  message: `Ê†∑ÂºèÊñá‰ª∂ÁΩëÁªúÈîôËØØ: ${url} - ${errorText}`,
                  url: url,
                  timestamp: errorInfo.timestamp
                });
              } else if (url.match(/\.js$/i) || resourceType === 'script') {
                resourceErrors.js.push(errorInfo);
              } else if (resourceType === 'image') {
                resourceErrors.images.push(errorInfo);
              } else if (url.match(/\.(woff|woff2|ttf|eot|otf)$/i)) {
                resourceErrors.fonts.push(errorInfo);
              }

              // Ê£ÄÊµãÂπøÂëäÁΩëÁªúÈîôËØØ
              if (url.includes('googlesyndication') || 
                  url.includes('doubleclick') || 
                  url.includes('adservice') ||
                  url.includes('googleadservices') ||
                  url.includes('pagead') ||
                  url.includes('/ads/')) {
                resourceErrors.ads.push(errorInfo);
                errors.push({
                  type: 'ad-network-error',
                  message: `ÂπøÂëäÁΩëÁªúÈîôËØØ: ${url} - ${errorText}`,
                  url: url,
                  timestamp: errorInfo.timestamp
                });
              }
            });

            try {
              console.log(`Ê≠£Âú®ËÆøÈóÆ: ${url}`);
              await page.goto(url, { 
                waitUntil: 'networkidle2',
                timeout: 60000 
              });
              
              // Á≠âÂæÖÊåáÂÆöÊó∂Èó¥
              await new Promise(resolve => setTimeout(resolve, duration * 1000));
              
            } catch (error) {
              errors.push({
                type: 'navigation',
                message: `ÂØºËà™ÈîôËØØ: ${error.message}`,
                timestamp: new Date().toISOString()
              });
            }

            await browser.close();

            return {
              url,
              errors,
              warnings,
              logs: logs.slice(0, 50), // ÈôêÂà∂Êó•ÂøóÊï∞Èáè
              networkErrors,
              resourceErrors,
              timestamp: new Date().toISOString()
            };
          }

          function generateMarkdown(results) {
            let md = `# ÁΩëÈ°µÊéßÂà∂Âè∞ÈîôËØØÊä•Âëä\n\n`;
            md += `ÁîüÊàêÊó∂Èó¥: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n\n`;
            md += `---\n\n`;

            results.forEach((result, index) => {
              md += `## ${index + 1}. ${result.url}\n\n`;
              md += `Ê£ÄÊü•Êó∂Èó¥: ${new Date(result.timestamp).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n\n`;

              // ÈîôËØØÁªüËÆ°
              md += `### üìä ÁªüËÆ°‰ø°ÊÅØ\n\n`;
              md += `- ‚ùå ÈîôËØØÊï∞Èáè: ${result.errors.length}\n`;
              md += `- ‚ö†Ô∏è Ë≠¶ÂëäÊï∞Èáè: ${result.warnings.length}\n`;
              md += `- üåê ÁΩëÁªúÈîôËØØ: ${result.networkErrors.length}\n`;
              md += `- üé® CSSÂä†ËΩΩÂ§±Ë¥•: ${result.resourceErrors.css.length}\n`;
              md += `- üìú JSÂä†ËΩΩÂ§±Ë¥•: ${result.resourceErrors.js.length}\n`;
              md += `- üñºÔ∏è ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•: ${result.resourceErrors.images.length}\n`;
              md += `- üî§ Â≠ó‰ΩìÂä†ËΩΩÂ§±Ë¥•: ${result.resourceErrors.fonts.length}\n`;
              md += `- üì¢ ÂπøÂëäÂä†ËΩΩÂ§±Ë¥•: ${result.resourceErrors.ads.length}\n\n`;

              // ÈîôËØØËØ¶ÊÉÖ
              if (result.errors.length > 0) {
                md += `### ‚ùå ÈîôËØØÂàóË°®\n\n`;
                result.errors.forEach((error, idx) => {
                  md += `#### ÈîôËØØ ${idx + 1}\n\n`;
                  md += `- **Á±ªÂûã**: ${error.type}\n`;
                  md += `- **Ê∂àÊÅØ**: \`${error.message}\`\n`;
                  if (error.url) md += `- **Êñá‰ª∂**: ${error.url}\n`;
                  if (error.line) md += `- **‰ΩçÁΩÆ**: Á¨¨ ${error.line} Ë°åÔºåÁ¨¨ ${error.column} Âàó\n`;
                  if (error.stack) md += `- **Â†ÜÊ†à**:\n\`\`\`\n${error.stack}\n\`\`\`\n`;
                  md += `- **Êó∂Èó¥**: ${new Date(error.timestamp).toLocaleTimeString('zh-CN')}\n\n`;
                });
              }

              // Ë≠¶ÂëäËØ¶ÊÉÖ
              if (result.warnings.length > 0) {
                md += `### ‚ö†Ô∏è Ë≠¶ÂëäÂàóË°®\n\n`;
                result.warnings.slice(0, 10).forEach((warning, idx) => {
                  md += `${idx + 1}. \`${warning.message}\`\n`;
                  if (warning.url) md += `   - Êñá‰ª∂: ${warning.url}:${warning.line}\n`;
                });
                if (result.warnings.length > 10) {
                  md += `\n*ËøòÊúâ ${result.warnings.length - 10} Êù°Ë≠¶ÂëäÊú™ÊòæÁ§∫*\n`;
                }
                md += `\n`;
              }

              // ÁΩëÁªúÈîôËØØ
              if (result.networkErrors.length > 0) {
                md += `### üåê ÁΩëÁªúÈîôËØØ\n\n`;
                result.networkErrors.forEach((netError, idx) => {
                  md += `${idx + 1}. **${netError.method}** ${netError.url}\n`;
                  md += `   - ÈîôËØØ: ${netError.errorText}\n\n`;
                });
              }

              // CSSÂä†ËΩΩÈîôËØØ
              if (result.resourceErrors.css.length > 0) {
                md += `### üé® CSSÊ†∑ÂºèÂä†ËΩΩÈîôËØØ\n\n`;
                result.resourceErrors.css.forEach((cssError, idx) => {
                  md += `${idx + 1}. ${cssError.url}\n`;
                  if (cssError.status) {
                    md += `   - HTTPÁä∂ÊÄÅ: ${cssError.status} ${cssError.statusText}\n`;
                  } else if (cssError.errorText) {
                    md += `   - ÈîôËØØ: ${cssError.errorText}\n`;
                  }
                  md += `\n`;
                });
              }

              // JSÂä†ËΩΩÈîôËØØ
              if (result.resourceErrors.js.length > 0) {
                md += `### üìú JavaScriptÂä†ËΩΩÈîôËØØ\n\n`;
                result.resourceErrors.js.forEach((jsError, idx) => {
                  md += `${idx + 1}. ${jsError.url}\n`;
                  if (jsError.status) {
                    md += `   - HTTPÁä∂ÊÄÅ: ${jsError.status} ${jsError.statusText}\n`;
                  } else if (jsError.errorText) {
                    md += `   - ÈîôËØØ: ${jsError.errorText}\n`;
                  }
                  md += `\n`;
                });
              }

              // ÂπøÂëäÂä†ËΩΩÈîôËØØ
              if (result.resourceErrors.ads.length > 0) {
                md += `### üì¢ GoogleÂπøÂëäÂä†ËΩΩÈîôËØØ\n\n`;
                result.resourceErrors.ads.forEach((adError, idx) => {
                  md += `${idx + 1}. ${adError.url}\n`;
                  if (adError.status) {
                    md += `   - HTTPÁä∂ÊÄÅ: ${adError.status} ${adError.statusText}\n`;
                  } else if (adError.errorText) {
                    md += `   - ÁΩëÁªúÈîôËØØ: ${adError.errorText}\n`;
                  }
                  md += `   - Êó∂Èó¥: ${new Date(adError.timestamp).toLocaleTimeString('zh-CN')}\n\n`;
                });
                
                md += `> **ÊèêÁ§∫**: ÂπøÂëäÂä†ËΩΩÂ§±Ë¥•ÂèØËÉΩÁî±‰∫é:\n`;
                md += `> - ÂπøÂëäÊã¶Êà™Êèí‰ª∂\n`;
                md += `> - ÁΩëÁªúÈôêÂà∂ÊàñÈò≤ÁÅ´Â¢ô\n`;
                md += `> - Âú∞Âå∫ÈôêÂà∂\n`;
                md += `> - GoogleÂπøÂëäÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®\n\n`;
              }

              // ÂõæÁâáÂä†ËΩΩÈîôËØØÔºàÂ¶ÇÊûúÊï∞ÈáèËæÉÂ§öÂè™ÊòæÁ§∫ÈÉ®ÂàÜÔºâ
              if (result.resourceErrors.images.length > 0) {
                md += `### üñºÔ∏è ÂõæÁâáÂä†ËΩΩÈîôËØØ\n\n`;
                const imagesToShow = result.resourceErrors.images.slice(0, 10);
                imagesToShow.forEach((imgError, idx) => {
                  md += `${idx + 1}. ${imgError.url}\n`;
                  if (imgError.status) {
                    md += `   - HTTPÁä∂ÊÄÅ: ${imgError.status}\n`;
                  } else if (imgError.errorText) {
                    md += `   - ÈîôËØØ: ${imgError.errorText}\n`;
                  }
                  md += `\n`;
                });
                if (result.resourceErrors.images.length > 10) {
                  md += `*ËøòÊúâ ${result.resourceErrors.images.length - 10} Âº†ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•*\n\n`;
                }
              }

              // Â≠ó‰ΩìÂä†ËΩΩÈîôËØØ
              if (result.resourceErrors.fonts.length > 0) {
                md += `### üî§ Â≠ó‰ΩìÂä†ËΩΩÈîôËØØ\n\n`;
                result.resourceErrors.fonts.forEach((fontError, idx) => {
                  md += `${idx + 1}. ${fontError.url}\n`;
                  if (fontError.status) {
                    md += `   - HTTPÁä∂ÊÄÅ: ${fontError.status}\n`;
                  } else if (fontError.errorText) {
                    md += `   - ÈîôËØØ: ${fontError.errorText}\n`;
                  }
                  md += `\n`;
                });
              }

              md += `---\n\n`;
            });

            return md;
          }

          async function main() {
            const urls = getUrlsToCheck();
            const duration = parseInt(process.env.INPUT_DURATION || '30');

            if (urls.length === 0) {
              console.log('‚ùå Ê≤°ÊúâÊâæÂà∞Ë¶ÅÊ£ÄÊü•ÁöÑURL');
              process.exit(1);
            }

            console.log(`Â∞ÜÊ£ÄÊü• ${urls.length} ‰∏™URLÔºåÊØè‰∏™È°µÈù¢Á≠âÂæÖ ${duration} Áßí\n`);

            const results = [];
            for (const url of urls) {
              try {
                const result = await checkPageErrors(url, duration);
                results.push(result);
                console.log(`‚úÖ ÂÆåÊàê: ${url} (ÈîôËØØ: ${result.errors.length}, Ë≠¶Âëä: ${result.warnings.length})\n`);
              } catch (error) {
                console.error(`‚ùå Ê£ÄÊü•Â§±Ë¥•: ${url}`, error);
                results.push({
                  url,
                  errors: [{ type: 'system', message: error.message, timestamp: new Date().toISOString() }],
                  warnings: [],
                  logs: [],
                  networkErrors: [],
                  resourceErrors: { css: [], js: [], images: [], fonts: [], ads: [] },
                  timestamp: new Date().toISOString()
                });
              }
            }

            // ÁîüÊàêÊä•Âëä
            const markdown = generateMarkdown(results);
            const reportDir = path.join(process.cwd(), 'reports');
            
            if (!fs.existsSync(reportDir)) {
              fs.mkdirSync(reportDir, { recursive: true });
            }

            const reportPath = path.join(reportDir, `error-report-${Date.now()}.md`);
            fs.writeFileSync(reportPath, markdown);
            fs.writeFileSync(path.join(reportDir, 'latest.md'), markdown);

            console.log(`\nüìù Êä•ÂëäÂ∑≤ÁîüÊàê: ${reportPath}`);

            // ËæìÂá∫ÊÄªÁªì
            const totalErrors = results.reduce((sum, r) => sum + r.errors.length, 0);
            const totalWarnings = results.reduce((sum, r) => sum + r.warnings.length, 0);
            
            console.log(`\n=== ÊÄªÁªì ===`);
            console.log(`ÊÄªÈîôËØØÊï∞: ${totalErrors}`);
            console.log(`ÊÄªË≠¶ÂëäÊï∞: ${totalWarnings}`);

            if (totalErrors > 0) {
              process.exit(1);
            }
          }

          main().catch(console.error);
          EOF

      - name: Run error check
        env:
          INPUT_URLS: ${{ github.event.inputs.urls }}
          INPUT_DURATION: ${{ github.event.inputs.duration }}
        run: node check-errors.js

      - name: Upload error report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: error-report-${{ github.run_number }}
          path: reports/
          retention-days: 30

      - name: Comment PR with report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'reports/latest.md';
            
            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

      - name: Commit report to repository
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add reports/ || true
          git commit -m "üìù Add error report - $(date +'%Y-%m-%d %H:%M:%S')" || true
          git push || true
