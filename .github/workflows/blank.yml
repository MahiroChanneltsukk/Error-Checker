name: Web Console Error Checker

on:
  workflow_dispatch:
    inputs:
      urls:
        description: 'è¦æ£€æŸ¥çš„URLåˆ—è¡¨ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰'
        required: false
        default: ''
      duration:
        description: 'æ¯ä¸ªé¡µé¢ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰'
        required: false
        default: '30'
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  check-console-errors:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
          install-chromedriver: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install selenium-webdriver

      - name: Create error checker script
        run: |
          cat > check-errors.js << 'EOF'
          const { Builder, By, until, logging } = require('selenium-webdriver');
          const chrome = require('selenium-webdriver/chrome');
          const fs = require('fs');
          const path = require('path');

          // ä»ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶è¯»å–URLåˆ—è¡¨
          function getUrlsToCheck() {
            const inputUrls = process.env.INPUT_URLS;
            const configPath = path.join(process.cwd(), 'urls-config.json');
            
            if (inputUrls && inputUrls.trim()) {
              return inputUrls.split(',').map(url => url.trim()).filter(Boolean);
            }
            
            if (fs.existsSync(configPath)) {
              const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
              return config.urls || [];
            }
            
            return [];
          }

          async function checkPageErrors(url, duration) {
            const options = new chrome.Options();
            options.addArguments(
              '--headless=new',
              '--no-sandbox',
              '--disable-dev-shm-usage',
              '--disable-gpu',
              '--window-size=1920,1080',
              '--disable-blink-features=AutomationControlled'
            );

            // å¯ç”¨æµè§ˆå™¨æ—¥å¿—
            const prefs = new logging.Preferences();
            prefs.setLevel(logging.Type.BROWSER, logging.Level.ALL);
            prefs.setLevel(logging.Type.DRIVER, logging.Level.ALL);
            prefs.setLevel(logging.Type.PERFORMANCE, logging.Level.ALL);

            const driver = await new Builder()
              .forBrowser('chrome')
              .setChromeOptions(options)
              .setLoggingPrefs(prefs)
              .build();

            const errors = [];
            const warnings = [];
            const networkErrors = [];
            const resourceErrors = {
              css: [],
              js: [],
              images: [],
              fonts: [],
              ads: []
            };

            try {
              console.log(`æ­£åœ¨è®¿é—®: ${url}`);
              
              // å¯ç”¨æ€§èƒ½æ—¥å¿—ä»¥æ•è·ç½‘ç»œè¯·æ±‚
              await driver.get(url);
              
              // ç­‰å¾…é¡µé¢åŠ è½½
              await driver.wait(until.elementLocated(By.tagName('body')), 10000);
              
              // ç­‰å¾…æŒ‡å®šæ—¶é—´è®©æ‰€æœ‰èµ„æºåŠ è½½
              await new Promise(resolve => setTimeout(resolve, duration * 1000));

              // è·å–æµè§ˆå™¨æ—¥å¿—
              const browserLogs = await driver.manage().logs().get(logging.Type.BROWSER);
              
              browserLogs.forEach(entry => {
                const message = entry.message;
                const level = entry.level.name;
                const timestamp = new Date(entry.timestamp).toISOString();

                const logEntry = {
                  type: level.toLowerCase(),
                  message: message,
                  timestamp: timestamp,
                  level: level
                };

                // è§£æURLå’Œé”™è¯¯ç±»å‹
                let errorUrl = '';
                const urlMatch = message.match(/https?:\/\/[^\s"')]+/);
                if (urlMatch) {
                  errorUrl = urlMatch[0];
                }

                // åˆ†ç±»é”™è¯¯
                if (level === 'SEVERE' || level === 'ERROR') {
                  // CSSé”™è¯¯
                  if (message.includes('.css') || 
                      message.toLowerCase().includes('stylesheet') ||
                      (errorUrl && errorUrl.match(/\.css(\?|$)/))) {
                    const cssError = {
                      url: errorUrl || 'unknown',
                      message: message,
                      timestamp: timestamp
                    };
                    resourceErrors.css.push(cssError);
                    errors.push({
                      type: 'css-error',
                      message: `CSSåŠ è½½é”™è¯¯: ${message}`,
                      url: errorUrl,
                      timestamp: timestamp
                    });
                  }
                  // JSé”™è¯¯
                  else if (message.includes('.js') || 
                           message.toLowerCase().includes('script') ||
                           (errorUrl && errorUrl.match(/\.js(\?|$)/))) {
                    const jsError = {
                      url: errorUrl || 'unknown',
                      message: message,
                      timestamp: timestamp
                    };
                    resourceErrors.js.push(jsError);
                    errors.push({
                      type: 'js-error',
                      message: `JavaScripté”™è¯¯: ${message}`,
                      url: errorUrl,
                      timestamp: timestamp
                    });
                  }
                  // å¹¿å‘Šé”™è¯¯
                  else if (message.includes('googlesyndication') ||
                           message.includes('doubleclick') ||
                           message.includes('adservice') ||
                           message.includes('googleadservices') ||
                           message.includes('pagead') ||
                           message.includes('adsbygoogle')) {
                    const adError = {
                      url: errorUrl || 'unknown',
                      message: message,
                      timestamp: timestamp
                    };
                    resourceErrors.ads.push(adError);
                    errors.push({
                      type: 'ad-error',
                      message: `å¹¿å‘ŠåŠ è½½é”™è¯¯: ${message}`,
                      url: errorUrl,
                      timestamp: timestamp
                    });
                  }
                  // å›¾ç‰‡é”™è¯¯
                  else if (message.match(/\.(jpg|jpeg|png|gif|svg|webp|ico)/i) ||
                           (errorUrl && errorUrl.match(/\.(jpg|jpeg|png|gif|svg|webp|ico)(\?|$)/i))) {
                    resourceErrors.images.push({
                      url: errorUrl || 'unknown',
                      message: message,
                      timestamp: timestamp
                    });
                  }
                  // å­—ä½“é”™è¯¯
                  else if (message.match(/\.(woff|woff2|ttf|eot|otf)/i) ||
                           (errorUrl && errorUrl.match(/\.(woff|woff2|ttf|eot|otf)(\?|$)/i))) {
                    resourceErrors.fonts.push({
                      url: errorUrl || 'unknown',
                      message: message,
                      timestamp: timestamp
                    });
                  }
                  // ç½‘ç»œé”™è¯¯
                  else if (message.includes('ERR_') || 
                           message.includes('Failed to load') ||
                           message.includes('net::') ||
                           message.includes('404') ||
                           message.includes('500') ||
                           message.includes('403')) {
                    networkErrors.push({
                      url: errorUrl || 'unknown',
                      message: message,
                      timestamp: timestamp
                    });
                  }
                  // å…¶ä»–é”™è¯¯
                  else {
                    errors.push(logEntry);
                  }
                } else if (level === 'WARNING') {
                  warnings.push(logEntry);
                }
              });

              // æ‰§è¡Œè‡ªå®šä¹‰JavaScriptæ£€æŸ¥é¡µé¢é”™è¯¯
              const pageErrors = await driver.executeScript(`
                const errors = [];
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªåŠ è½½çš„æ ·å¼è¡¨
                const stylesheets = document.styleSheets;
                for (let i = 0; i < stylesheets.length; i++) {
                  try {
                    const sheet = stylesheets[i];
                    if (!sheet.cssRules && !sheet.rules) {
                      errors.push({
                        type: 'css-blocked',
                        url: sheet.href || 'inline style',
                        message: 'CSSæ ·å¼è¡¨æ— æ³•è®¿é—®ï¼ˆå¯èƒ½è¢«CORSé˜»æ­¢ï¼‰'
                      });
                    }
                  } catch (e) {
                    errors.push({
                      type: 'css-access-error',
                      url: stylesheets[i].href || 'unknown',
                      message: 'CSSè®¿é—®é”™è¯¯: ' + e.message
                    });
                  }
                }

                // æ£€æŸ¥å›¾ç‰‡åŠ è½½å¤±è´¥
                const images = document.querySelectorAll('img');
                images.forEach(img => {
                  if (!img.complete || img.naturalHeight === 0) {
                    errors.push({
                      type: 'image-load-error',
                      url: img.src,
                      message: 'å›¾ç‰‡åŠ è½½å¤±è´¥'
                    });
                  }
                });

                // æ£€æŸ¥Googleå¹¿å‘Šæ˜¯å¦åŠ è½½
                const adSlots = document.querySelectorAll('ins.adsbygoogle');
                adSlots.forEach(slot => {
                  if (!slot.getAttribute('data-ad-status') || 
                      slot.getAttribute('data-ad-status') === 'unfilled') {
                    errors.push({
                      type: 'ad-unfilled',
                      message: 'å¹¿å‘Šä½æœªå¡«å……',
                      element: slot.className
                    });
                  }
                });

                // æ£€æŸ¥å¹¿å‘Šè„šæœ¬æ˜¯å¦åŠ è½½
                if (typeof adsbygoogle === 'undefined' && document.querySelector('ins.adsbygoogle')) {
                  errors.push({
                    type: 'ad-script-missing',
                    message: 'Googleå¹¿å‘Šè„šæœ¬æœªåŠ è½½ï¼ˆadsbygoogleæœªå®šä¹‰ï¼‰'
                  });
                }

                return errors;
              `);

              // åˆå¹¶é¡µé¢æ£€æŸ¥ç»“æœ
              pageErrors.forEach(err => {
                if (err.type.includes('css')) {
                  resourceErrors.css.push(err);
                } else if (err.type.includes('image')) {
                  resourceErrors.images.push(err);
                } else if (err.type.includes('ad')) {
                  resourceErrors.ads.push(err);
                }
                errors.push(err);
              });

            } catch (error) {
              errors.push({
                type: 'navigation',
                message: `å¯¼èˆªé”™è¯¯: ${error.message}`,
                timestamp: new Date().toISOString()
              });
            } finally {
              await driver.quit();
            }

            return {
              url,
              errors,
              warnings,
              networkErrors,
              resourceErrors,
              timestamp: new Date().toISOString()
            };
          }

          function generateMarkdown(results) {
            let md = `# ç½‘é¡µæ§åˆ¶å°é”™è¯¯æŠ¥å‘Š\n\n`;
            md += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n\n`;
            md += `Chromeç‰ˆæœ¬: 120\n\n`;
            md += `---\n\n`;

            results.forEach((result, index) => {
              md += `## ${index + 1}. ${result.url}\n\n`;
              md += `æ£€æŸ¥æ—¶é—´: ${new Date(result.timestamp).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n\n`;

              // é”™è¯¯ç»Ÿè®¡
              md += `### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\n\n`;
              md += `- âŒ é”™è¯¯æ•°é‡: ${result.errors.length}\n`;
              md += `- âš ï¸ è­¦å‘Šæ•°é‡: ${result.warnings.length}\n`;
              md += `- ğŸŒ ç½‘ç»œé”™è¯¯: ${result.networkErrors.length}\n`;
              md += `- ğŸ¨ CSSåŠ è½½å¤±è´¥: ${result.resourceErrors.css.length}\n`;
              md += `- ğŸ“œ JSåŠ è½½å¤±è´¥: ${result.resourceErrors.js.length}\n`;
              md += `- ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½å¤±è´¥: ${result.resourceErrors.images.length}\n`;
              md += `- ğŸ”¤ å­—ä½“åŠ è½½å¤±è´¥: ${result.resourceErrors.fonts.length}\n`;
              md += `- ğŸ“¢ å¹¿å‘Šé—®é¢˜: ${result.resourceErrors.ads.length}\n\n`;

              // CSSåŠ è½½é”™è¯¯
              if (result.resourceErrors.css.length > 0) {
                md += `### ğŸ¨ CSSæ ·å¼åŠ è½½é”™è¯¯\n\n`;
                result.resourceErrors.css.forEach((cssError, idx) => {
                  md += `${idx + 1}. **${cssError.url || 'Unknown'}**\n`;
                  md += `   - æ¶ˆæ¯: ${cssError.message}\n`;
                  if (cssError.timestamp) {
                    md += `   - æ—¶é—´: ${new Date(cssError.timestamp).toLocaleTimeString('zh-CN')}\n`;
                  }
                  md += `\n`;
                });
              }

              // JSåŠ è½½é”™è¯¯
              if (result.resourceErrors.js.length > 0) {
                md += `### ğŸ“œ JavaScriptåŠ è½½é”™è¯¯\n\n`;
                result.resourceErrors.js.forEach((jsError, idx) => {
                  md += `${idx + 1}. **${jsError.url || 'Unknown'}**\n`;
                  md += `   - æ¶ˆæ¯: ${jsError.message}\n`;
                  if (jsError.timestamp) {
                    md += `   - æ—¶é—´: ${new Date(jsError.timestamp).toLocaleTimeString('zh-CN')}\n`;
                  }
                  md += `\n`;
                });
              }

              // å¹¿å‘ŠåŠ è½½é”™è¯¯
              if (result.resourceErrors.ads.length > 0) {
                md += `### ğŸ“¢ Googleå¹¿å‘Šé—®é¢˜\n\n`;
                result.resourceErrors.ads.forEach((adError, idx) => {
                  md += `${idx + 1}. ${adError.type || 'ad-error'}\n`;
                  if (adError.url) {
                    md += `   - URL: ${adError.url}\n`;
                  }
                  md += `   - æ¶ˆæ¯: ${adError.message}\n`;
                  if (adError.element) {
                    md += `   - å…ƒç´ : ${adError.element}\n`;
                  }
                  if (adError.timestamp) {
                    md += `   - æ—¶é—´: ${new Date(adError.timestamp).toLocaleTimeString('zh-CN')}\n`;
                  }
                  md += `\n`;
                });
                
                md += `> **æç¤º**: å¹¿å‘Šé—®é¢˜å¯èƒ½ç”±äº:\n`;
                md += `> - å¹¿å‘Šæ‹¦æˆªæ’ä»¶ï¼ˆæµè§ˆå™¨æ‰©å±•æˆ–ç³»ç»Ÿçº§ï¼‰\n`;
                md += `> - ç½‘ç»œé™åˆ¶æˆ–é˜²ç«å¢™è§„åˆ™\n`;
                md += `> - CORSç­–ç•¥é™åˆ¶\n`;
                md += `> - åœ°åŒºé™åˆ¶æˆ–IPå°ç¦\n`;
                md += `> - Googleå¹¿å‘ŠæœåŠ¡æš‚æ—¶ä¸å¯ç”¨\n`;
                md += `> - å¹¿å‘Šä½æœªæ­£ç¡®é…ç½®\n\n`;
              }

              // å›¾ç‰‡åŠ è½½é”™è¯¯
              if (result.resourceErrors.images.length > 0) {
                md += `### ğŸ–¼ï¸ å›¾ç‰‡åŠ è½½é”™è¯¯\n\n`;
                const imagesToShow = result.resourceErrors.images.slice(0, 10);
                imagesToShow.forEach((imgError, idx) => {
                  md += `${idx + 1}. ${imgError.url}\n`;
                  md += `   - æ¶ˆæ¯: ${imgError.message}\n\n`;
                });
                if (result.resourceErrors.images.length > 10) {
                  md += `*è¿˜æœ‰ ${result.resourceErrors.images.length - 10} å¼ å›¾ç‰‡åŠ è½½å¤±è´¥*\n\n`;
                }
              }

              // å­—ä½“åŠ è½½é”™è¯¯
              if (result.resourceErrors.fonts.length > 0) {
                md += `### ğŸ”¤ å­—ä½“åŠ è½½é”™è¯¯\n\n`;
                result.resourceErrors.fonts.forEach((fontError, idx) => {
                  md += `${idx + 1}. ${fontError.url}\n`;
                  md += `   - æ¶ˆæ¯: ${fontError.message}\n\n`;
                });
              }

              // ç½‘ç»œé”™è¯¯
              if (result.networkErrors.length > 0) {
                md += `### ğŸŒ ç½‘ç»œé”™è¯¯\n\n`;
                result.networkErrors.forEach((netError, idx) => {
                  md += `${idx + 1}. ${netError.url}\n`;
                  md += `   - æ¶ˆæ¯: ${netError.message}\n\n`;
                });
              }

              // å…¶ä»–é”™è¯¯è¯¦æƒ…
              const otherErrors = result.errors.filter(e => 
                !['css-error', 'js-error', 'ad-error', 'image-load-error', 'css-blocked', 'css-access-error', 'ad-unfilled', 'ad-script-missing'].includes(e.type)
              );
              
              if (otherErrors.length > 0) {
                md += `### âŒ å…¶ä»–é”™è¯¯\n\n`;
                otherErrors.slice(0, 10).forEach((error, idx) => {
                  md += `#### é”™è¯¯ ${idx + 1}\n\n`;
                  md += `- **ç±»å‹**: ${error.type}\n`;
                  md += `- **æ¶ˆæ¯**: \`${error.message}\`\n`;
                  if (error.url) md += `- **URL**: ${error.url}\n`;
                  if (error.timestamp) md += `- **æ—¶é—´**: ${new Date(error.timestamp).toLocaleTimeString('zh-CN')}\n`;
                  md += `\n`;
                });
                if (otherErrors.length > 10) {
                  md += `*è¿˜æœ‰ ${otherErrors.length - 10} ä¸ªé”™è¯¯æœªæ˜¾ç¤º*\n\n`;
                }
              }

              // è­¦å‘Šè¯¦æƒ…
              if (result.warnings.length > 0) {
                md += `### âš ï¸ è­¦å‘Šåˆ—è¡¨\n\n`;
                result.warnings.slice(0, 10).forEach((warning, idx) => {
                  md += `${idx + 1}. \`${warning.message}\`\n`;
                });
                if (result.warnings.length > 10) {
                  md += `\n*è¿˜æœ‰ ${result.warnings.length - 10} æ¡è­¦å‘Šæœªæ˜¾ç¤º*\n`;
                }
                md += `\n`;
              }

              md += `---\n\n`;
            });

            return md;
          }

          async function main() {
            const urls = getUrlsToCheck();
            const duration = parseInt(process.env.INPUT_DURATION || '30');

            if (urls.length === 0) {
              console.log('âŒ æ²¡æœ‰æ‰¾åˆ°è¦æ£€æŸ¥çš„URL');
              console.log('è¯·åœ¨workflowè¾“å…¥ä¸­æä¾›URLï¼Œæˆ–åœ¨ä»“åº“æ ¹ç›®å½•åˆ›å»º urls-config.json æ–‡ä»¶');
              process.exit(1);
            }

            console.log(`å°†ä½¿ç”¨Chrome 120æ£€æŸ¥ ${urls.length} ä¸ªURLï¼Œæ¯ä¸ªé¡µé¢ç­‰å¾… ${duration} ç§’\n`);

            const results = [];
            for (const url of urls) {
              try {
                const result = await checkPageErrors(url, duration);
                results.push(result);
                console.log(`âœ… å®Œæˆ: ${url}`);
                console.log(`   é”™è¯¯: ${result.errors.length}, è­¦å‘Š: ${result.warnings.length}`);
                console.log(`   CSSé”™è¯¯: ${result.resourceErrors.css.length}, å¹¿å‘Šé—®é¢˜: ${result.resourceErrors.ads.length}\n`);
              } catch (error) {
                console.error(`âŒ æ£€æŸ¥å¤±è´¥: ${url}`, error);
                results.push({
                  url,
                  errors: [{ type: 'system', message: error.message, timestamp: new Date().toISOString() }],
                  warnings: [],
                  networkErrors: [],
                  resourceErrors: { css: [], js: [], images: [], fonts: [], ads: [] },
                  timestamp: new Date().toISOString()
                });
              }
            }

            // ç”ŸæˆæŠ¥å‘Š
            const markdown = generateMarkdown(results);
            const reportDir = path.join(process.cwd(), 'reports');
            
            if (!fs.existsSync(reportDir)) {
              fs.mkdirSync(reportDir, { recursive: true });
            }

            const reportPath = path.join(reportDir, `error-report-${Date.now()}.md`);
            fs.writeFileSync(reportPath, markdown);
            fs.writeFileSync(path.join(reportDir, 'latest.md'), markdown);

            console.log(`\nğŸ“ æŠ¥å‘Šå·²ç”Ÿæˆ: ${reportPath}`);

            // è¾“å‡ºæ€»ç»“
            const totalErrors = results.reduce((sum, r) => sum + r.errors.length, 0);
            const totalWarnings = results.reduce((sum, r) => sum + r.warnings.length, 0);
            const totalCssErrors = results.reduce((sum, r) => sum + r.resourceErrors.css.length, 0);
            const totalAdErrors = results.reduce((sum, r) => sum + r.resourceErrors.ads.length, 0);
            
            console.log(`\n=== æ€»ç»“ ===`);
            console.log(`æ€»é”™è¯¯æ•°: ${totalErrors}`);
            console.log(`æ€»è­¦å‘Šæ•°: ${totalWarnings}`);
            console.log(`CSSé”™è¯¯: ${totalCssErrors}`);
            console.log(`å¹¿å‘Šé—®é¢˜: ${totalAdErrors}`);

            if (totalErrors > 0) {
              process.exit(1);
            }
          }

          main().catch(console.error);
          EOF

      - name: Run error check
        env:
          INPUT_URLS: ${{ github.event.inputs.urls }}
          INPUT_DURATION: ${{ github.event.inputs.duration }}
        run: node check-errors.js

      - name: Upload error report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: error-report-${{ github.run_number }}
          path: reports/
          retention-days: 30

      - name: Comment PR with report
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'reports/latest.md';
            
            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

      - name: Commit report to repository
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add reports/ || true
          git commit -m "ğŸ“ Add error report - $(date +'%Y-%m-%d %H:%M:%S')" || true
          git push || true
